# Воркер рассылки уведомлений

Воркер подключается к RabbitMQ и подписывается на очередь (default: `emails.send`).

При получении сообщения:

- Загружает шаблон уведомления из Mongo
    - Если в сообщении указан `template_id`, то ищет по нему, иначе пытается найти по событию и типу уведомления (`event` и `type`)
    - Если шаблон не найден, то ставит с БД пометку об ошибке и ждет следующего сообщения
- Для каждого пользователя из рассылки получает данные о нем из Auth сервиса
    - Если по какой-то причине Auth не найдет запрашиваемого пользователя, в логах будет оставлен `warning`
- Тему и тело сообщения обогащает данными пользователя и дополнительными данными из сообщения очереди (поле: `data`)
- Отправляет сообщение. Реализовано три класса:
    - `PrintEmailSender` выводит данные письма в консоль
    - `MailgunSender` (default) для отправки сообщений через сервис http://mailgun.com
    - `SendGridEmailSender` для отправки сообщений через сервис http://sendgrid.com
    - `MailgunSender` и `SendGridEmailSender` поддерживают экспоненциальный backoff, на случай проблем с удаленным сервисом
- Ставит в БД пометку об отправке уведомления 
